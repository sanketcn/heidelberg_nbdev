---

title: Lambdas


keywords: fastai
sidebar: home_sidebar



nb_path: "5_lambda_function.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 5_lambda_function.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Lamnda-to-Stream">Lamnda to Stream<a class="anchor-link" href="#Lamnda-to-Stream"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="n">STREAM_NAME</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;STREAM_NAME&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Incoming Event: &quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bucket &quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    
    <span class="c1"># csvfile = s3.get_object(Bucket=bucket, Key=file_key)</span>
    <span class="c1">#csvcontent = csvfile[&#39;Body&#39;].read().split(b&#39;\n&#39;)</span>
    <span class="c1">#csv_data = csv.DictReader(csvcontent)</span>
    
    <span class="n">records</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">]</span>
    
    <span class="n">key</span><span class="o">=</span><span class="n">records</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
    <span class="n">bucket</span><span class="o">=</span><span class="n">records</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;bucket&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    
    <span class="n">s3_resource</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
    <span class="n">s3_object</span> <span class="o">=</span> <span class="n">s3_resource</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">s3_object</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="c1">#print(&#39;headers: %s&#39; %(headers))</span>
    <span class="n">payloads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># refernece:- https://stackoverflow.com/questions/56849240/how-to-read-csv-file-from-s3-bucket-in-aws-lambda</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1">#print complete line</span>
        <span class="c1">#print(line)</span>
        <span class="c1">#print index wise</span>
        <span class="c1">#print(line[0], line[1])</span>
        <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">d</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="s2">&quot;target&quot;</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>

        <span class="n">payloads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="n">payloads</span><span class="p">:</span>
        <span class="n">put_to_stream</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span><span class="n">STREAM_NAME</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;statusCode&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="s1">&#39;Hello from Lambda!&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    
    
<span class="k">def</span> <span class="nf">put_to_stream</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="n">timestamp</span><span class="p">,</span><span class="n">STREAM_NAME</span><span class="p">):</span>
    <span class="n">ret_status</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending a new payload: &#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">kinesis_client</span><span class="o">.</span><span class="n">put_record</span><span class="p">(</span><span class="n">StreamName</span> <span class="o">=</span> <span class="n">STREAM_NAME</span> <span class="p">,</span>
                                             <span class="n">Data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
                                             <span class="n">PartitionKey</span> <span class="o">=</span> <span class="s1">&#39;shard1&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Kinesis put_record failed: </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)))</span>
        <span class="n">ret_status</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">return</span> <span class="n">ret_status</span>



<span class="k">def</span> <span class="nf">get_cloudwatch_logs_url</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span><span class="n">predict_lambda_name</span><span class="p">):</span>
    <span class="n">log_group_name</span> <span class="o">=</span> <span class="s1">&#39;/aws/lambda/&#39;</span> <span class="o">+</span> <span class="n">predict_lambda_name</span> 
    <span class="c1"># get the latest log stream for our Lambda that makes fraud predictions</span>
    <span class="n">cw_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">)</span>
    <span class="n">last_cw_evt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">last_cw_evt</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_test_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="n">streams</span> <span class="o">=</span> <span class="n">cw_client</span><span class="o">.</span><span class="n">describe_log_streams</span><span class="p">(</span><span class="n">logGroupName</span><span class="o">=</span><span class="n">log_group_name</span><span class="p">,</span>
                                                 <span class="n">orderBy</span><span class="o">=</span><span class="s1">&#39;LastEventTime&#39;</span><span class="p">,</span>
                                                 <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;logStreams&#39;</span><span class="p">]</span>
        <span class="n">last_cw_evt</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lastIngestionTime&#39;</span><span class="p">]</span> <span class="c1">#&#39;lastEventTimestamp&#39;]</span>
        <span class="n">latest_stream</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logStreamName&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;$252F&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[$LATEST]&#39;</span><span class="p">,</span> <span class="s1">&#39;$255B$2524LATEST$255D&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_cw_evt</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_test_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;waiting for updated log stream...&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># produce a valid URL to get to that log stream</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span><span class="o">.</span><span class="n">region_name</span>
    <span class="n">log_group_escaped</span> <span class="o">=</span> <span class="n">log_group_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;$252F&#39;</span><span class="p">)</span>
    <span class="n">cw_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://console.aws.amazon.com/cloudwatch/home?region=</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s1">#logsV2:log-groups/log-group/</span><span class="si">{</span><span class="n">log_group_escaped</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">time_filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;$26start$3D</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">start_test_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10000</span><span class="si">}</span><span class="s1">$26end$3D</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">end_test_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">40000</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">full_cw_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cw_url</span><span class="si">}</span><span class="s1">/log-events/</span><span class="si">{</span><span class="n">latest_stream</span><span class="si">}</span><span class="s1">$3FfilterPattern$3DPrediction+</span><span class="si">{</span><span class="n">time_filter</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updated log stream is ready.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">full_cw_url</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

